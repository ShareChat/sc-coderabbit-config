# Google Spanner Best Practices
- path: "**/{spanner}*/**"
  instructions: |
    **Comprehensive Google Spanner Code Review Checklist:**
    
    **ğŸ”§ Client Lifecycle & Resource Management:**
    1. **Connection Management:**
       - âœ… Configure appropriate connection pool size and timeouts
       - âœ… Implement graceful client cleanup and shutdown
       - âœ… Handle connection failures with exponential backoff
       - âš ï¸ Never create new Spanner clients per request
    
    2. **Session Management:**
       - âœ… Reuse session instances throughout application lifecycle
       - âœ… Configure session-level timeouts and retry policies
       - âœ… Implement proper session cleanup in application shutdown
    
    **ğŸ“Š Transaction Management:**
    3. **Transaction Types & Usage:**
       - âœ… Use `ReadOnlyTransaction` for read-only operations
       - âœ… Use `ReadWriteTransaction` for data modifications
    
    4. **Transaction Best Practices:**
       - âœ… **Error Handling**: Implement proper rollback and retry logic
       - âœ… **Monitoring**: Track transaction duration and failure rates
    
    **ğŸš€ Performance & Query Optimization:**
    5. **Query Timeouts:**
       - âœ… Set explicit timeouts for all Spanner queries (typically 5-60 seconds). This is during client initialization
       - âœ… Configure different timeouts for reads vs writes
       - âœ… Implement query cancellation for long-running operations
       - âœ… Use `StatementTimeout` for individual query timeouts
       - âš ï¸ Never use infinite timeouts - can cause resource exhaustion
    
    
    6. **Query Priority Management:**
       - âœ… Set appropriate query priorities: `HIGH`, `MEDIUM`, or `LOW`
       - âœ… **HIGH Priority**: Critical user-facing queries, real-time operations
       - âœ… **MEDIUM Priority**: Standard business operations, batch processing
       - âœ… **LOW Priority**: Background jobs, analytics, non-critical operations
       - âœ… Balance priority levels to manage resource contention effectively
    
    7. **FORCE_INDEX Usage:**
       - âœ… Use `FORCE_INDEX` when you need Spanner to use a specific index
       - âœ… **Use Cases**: Query optimization, performance testing, index validation
       - âœ… **Caution**: Only use when you're confident about index choice
       - âœ… **Monitoring**: Track query performance with forced vs automatic index selection
       - âœ… **Documentation**: Document why specific indexes are forced
    
    8. **Query Security:**
        - âœ… Use parameterized queries to prevent SQL injection
        - âœ… Use prepared statements for repeated queries
    
    **ğŸ“ˆ Error Handling & Resilience:**
    9. **Error Classification & Handling:**
        - âœ… Handle `AbortedException` for transaction conflicts
        - âœ… Handle `DeadlineExceededException` for timeout scenarios
        - âœ… Handle `ResourceExhaustedException` for quota limits
        - âœ… Handle `FailedPreconditionException` for invalid operations
    
    10. **Retry Strategies:**
        - âœ… Implement intelligent retry logic with exponential backoff
        - âœ… Use jitter in retry delays to prevent thundering herd
        - âœ… Distinguish between retryable and non-retryable errors
        - âœ… Implement backoff strategies for different error types
        - âœ… Monitor retry patterns and adjust strategies accordingly
    
    **ğŸ“Š Observability & Monitoring:**
    11. **Metrics & Monitoring:**
        - âœ… Track query latency and throughput
        - âœ… Monitor transaction success rates and durations
        - âœ… Monitor connection pool utilization
    
    
    **ğŸš¨ Common Anti-Patterns to Flag:**
    - âŒ Creating new Spanner clients per request
    - âŒ Missing query timeouts or infinite timeouts
    - âŒ Long-running transactions (>10 seconds)
    - âŒ No retry logic for transient failures
    - âŒ Missing query priority configuration
    - âŒ Hardcoded credentials or connection strings
    - âŒ No monitoring or metrics implementation
    - âŒ Missing error handling for different exception types
    - âŒ No transaction conflict resolution
    - âŒ **SELECT ***: Always specify required columns explicitly
    
    **ğŸ” Review Focus Areas:**
    - Verify client lifecycle management and connection pooling
    - Check transaction design and duration optimization
    - Ensure proper error handling and retry strategies
    - Validate security configurations and authentication
    - Identify opportunities for Prometheus metrics
    
    **ğŸ“Š Prometheus Metrics Opportunities:**
    - ğŸ” **Automatically suggest metrics when seeing:**
      - Spanner queries â†’ `spanner_queries_total{operation, priority, status}`
      - Query latency â†’ `spanner_query_duration_seconds{operation, priority}`
      - Transaction metrics â†’ `spanner_transactions_total{type, status}`
      - Connection usage â†’ `spanner_connections_active{state}`
      - Index operations â†’ `spanner_index_operations_total{operation, index_name}`
      - Error handling â†’ `spanner_errors_total{type, operation}`
      - Retry attempts â†’ `spanner_retries_total{operation, reason}`
