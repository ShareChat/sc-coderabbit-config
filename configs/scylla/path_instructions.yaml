# ScyllaDB Best Practices
- path: "**/{scylladb,scylla}*/**"
  instructions: |
    **Comprehensive ScyllaDB Code Review Checklist:**
    
    **ğŸ”§ Client Lifecycle & Resource Management:**
    1. **Connection Management:**
       - âœ… Configure appropriate connection pool size and timeouts
       - âœ… Implement graceful connection closing and cleanup
       - âœ… Handle connection failures with exponential backoff
       - âš ï¸ Never create new client connections per request
    
    2. **Session Management:**
       - âœ… Reuse session instances throughout application lifecycle
       - âœ… Configure session-level timeouts and retry policies
       - âœ… Implement proper session cleanup in application shutdown
       - âœ… Monitor session health and connection status
    
    **ğŸ“Š Query Performance & Optimization:**
    3. **Prepared Statements:**
       - âœ… Use prepared statements for frequently executed queries
       - âœ… Cache prepared statements at application level
       - âœ… Avoid dynamic query construction to prevent CQL injection
       - âœ… Monitor prepared statement cache hit rates
    
    4. **Query Timeouts:**
       - âœ… Set explicit timeouts for all queries (typically 5-30 seconds)
       - âœ… Configure different timeouts for reads vs writes
       - âœ… Implement query cancellation for long-running operations
       - âš ï¸ Never use infinite timeouts - can cause resource exhaustion
    
    5. **Consistency Levels:**
       - âœ… Explicitly set appropriate consistency levels for all operations
       - âœ… **Read Consistency**: `ONE` (fast), `LOCAL_QUORUM` (balanced), `QUORUM` (strong)
       - âœ… **Write Consistency**: `ONE` (fast), `LOCAL_QUORUM` (balanced), `QUORUM` (strong)
       - âœ… Understand trade-offs: higher consistency = lower availability + higher latency
       - âœ… Document consistency level choices with business justification
    
    **ğŸš€ Performance & Scalability:**
    6. **BYPASS CACHE Optimization:**
       - âœ… Use `BYPASS CACHE` for large range queries that aren't latency-sensitive
    
    7. **Batch Operations:**
       - âœ… Use batch statements for multiple related operations
       - âœ… Keep batch sizes reasonable (typically 10-100 operations)
    
    **ğŸ›¡ï¸ Security & Best Practices:**
    8. **Authentication & Authorization:**
       - âœ… Use proper authentication (username/password, certificates)
       - âœ… Use secure credential management (environment variables, not hardcoded)
    
    9. **Query Security:**
        - âœ… Use parameterized queries to prevent CQL injection
    
    **ğŸ“ˆ Error Handling & Resilience:**
    10. **Retry Strategies:**
        - âœ… Implement intelligent retry logic with exponential backoff
        - âœ… Use jitter in retry delays to prevent thundering herd
        - âš ï¸ **Critical**: Avoid aggressive retries during database surges
        - âœ… Monitor retry patterns and adjust strategies accordingly
    
    11. **Error Classification:**
        - âœ… Handle `UnavailableException` for temporary failures
        - âœ… Handle `ReadTimeoutException` and `WriteTimeoutException`
        - âœ… Handle `ConsistencyException` for consistency level violations
        - âœ… Implement circuit breaker patterns for persistent failures
    
    
    **ğŸ“Š Observability & Monitoring:**
    12. **Metrics & Monitoring:**
        - âœ… Track query latency and throughput
        - âœ… Monitor connection pool utilization
    
    13. **Logging & Tracing:**
        - âœ… Log slow queries and performance issues
        - âœ… Include correlation IDs for request tracing
        - âœ… Log consistency level violations and retries
        - âœ… Use structured logging with consistent field names
    
    **ğŸš¨ Common Anti-Patterns to Flag:**
    - âŒ Creating new ScyllaDB clients per request
    - âŒ Missing query timeouts or infinite timeouts
    - âŒ No retry logic for transient failures
    - âŒ Missing consistency level configuration
    - âŒ Hardcoded credentials or connection strings
    - âŒ No monitoring or metrics implementation
    - âŒ No prepared statement usage for repeated queries
    - âŒ Aggressive retries during database surges
    - âŒ Missing error handling for different exception types
    
    **ğŸ” Review Focus Areas:**
    - Verify client lifecycle management and connection pooling
    - Check query timeout configurations and consistency levels
    - Ensure proper error handling and retry strategies
    - Validate security configurations and authentication
    - Check for monitoring and observability implementation
    - Identify opportunities for Prometheus metrics
    
    **ğŸ“Š Prometheus Metrics Opportunities:**
    - ğŸ” **Automatically suggest metrics when seeing:**
      - ScyllaDB queries â†’ `scylla_queries_total{operation, consistency, status}`
      - Query latency â†’ `scylla_query_duration_seconds{operation, consistency}`
      - Connection usage â†’ `scylla_connections_active{state}`
      - Consistency violations â†’ `scylla_consistency_violations_total{operation}`
      - Retry attempts â†’ `scylla_retries_total{operation, reason}`
      - Cache operations â†’ `scylla_cache_operations_total{operation, status}`
  
