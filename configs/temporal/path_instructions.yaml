# Temporal Workflows & Activities Best Practices
- path: "**/{temporal,worker,workflow,task,activit}*/**"
  instructions: |
    **Comprehensive Temporal Code Review Checklist:**
    
    **ğŸ”’ Workflow Determinism (Critical):**
    1. **Deterministic Operations:**
       - âœ… **No System Time**: Never use `System.currentTimeMillis()`, `new Date()`, or similar
       - âœ… **No Random Numbers**: Never use `Math.random()`, `Random.nextInt()`, or similar
       - âœ… **No UUID Generation**: Never use `UUID.randomUUID()` or similar
       - âœ… **Use Temporal APIs**: Use `workflow.now()`, `workflow.randomUUID()`, `workflow.sideEffect()`
       - âš ï¸ **Critical**: Any non-deterministic operation will cause workflow replay failures
    
    2. **Side Effect Isolation:**
       - âœ… **No Direct I/O**: Never make database calls, network requests, or file system access
       - âœ… **No External Services**: Never call external APIs or services directly
       - âœ… **Delegate to Activities**: All side effects must be in Activities, not Workflows
       - âœ… **Pure Functions**: Workflows should be pure, deterministic functions
    
    3. **State Management:**
       - âœ… **No Global State**: Never use static variables or global mutable state
       - âœ… **No Concurrent Access**: Avoid concurrent data structures unless managed by Temporal
       - âœ… **Immutable Data**: Use immutable data structures when possible
       - âœ… **Workflow State**: Store state in workflow variables, not external storage
    
    **ğŸ“‹ Activity Design & Implementation:**
    4. **Activity Idempotency:**
       - âœ… **Always Idempotent**: Design activities to be safely retryable
       - âœ… **Idempotency Keys**: Use unique keys for operations with side effects
       - âœ… **State Checks**: Check current state before performing operations
       - âœ… **Compensation Logic**: Implement rollback mechanisms for failed operations
       - âœ… **No Side Effects**: Activities should be safe to execute multiple times
    
    5. **Activity Error Handling:**
       - âœ… **Retry Policies**: Configure appropriate retry policies for different error types
       - âœ… **Error Classification**: Distinguish between retryable and non-retryable errors
       - âœ… **Timeout Configuration**: Set appropriate `StartToCloseTimeout` values
       - âœ… **Heartbeating**: Implement heartbeating for long-running activities
       - âœ… **Circuit Breakers**: Use circuit breakers for external service calls
    
    6. **Activity Timeouts:**
       - âœ… **StartToCloseTimeout**: Maximum time for activity execution
       - âœ… **ScheduleToStartTimeout**: Maximum time to wait for worker assignment
       - âœ… **HeartbeatTimeout**: Maximum time between heartbeats
       - âœ… **ScheduleToCloseTimeout**: Maximum time from scheduling to completion
       - âœ… **Retry Policies**: Configure retry delays and maximum attempts
    
    **âš™ï¸ Worker Configuration & Management:**
    7. **Worker Concurrency:**
       - âœ… **Activity Concurrency**: Set `MaxConcurrentActivityExecutionSize` appropriately
       - âœ… **Workflow Concurrency**: Set `MaxConcurrentWorkflowTaskExecutionSize`
       - âœ… **Task Polling**: Configure `MaxConcurrentActivityTaskPollers`
       - âœ… **Workflow Polling**: Configure `MaxConcurrentWorkflowTaskPollers`
       - âœ… **Resource Limits**: Balance concurrency with available system resources
    
    8. **Worker Lifecycle:**
       - âœ… **Graceful Shutdown**: Implement proper shutdown procedures
       - âœ… **Health Checks**: Monitor worker health and availability
       - âœ… **Connection Management**: Handle Temporal service connection failures
       - âœ… **Task Processing**: Ensure tasks are processed efficiently
       - âœ… **Error Recovery**: Implement worker-level error recovery mechanisms
    
    **ğŸ”„ Workflow Orchestration:**
    9. **Workflow Structure:**
       - âœ… **Single Responsibility**: Each workflow should have one clear purpose
       - âœ… **Granular Activities**: Break complex operations into smaller activities
       - âœ… **Error Propagation**: Properly handle and propagate errors from activities
       - âœ… **Compensation Logic**: Implement rollback for failed workflow steps
       - âœ… **State Management**: Use workflow variables for state, not external storage
    
    
    **ğŸ“Š Error Handling & Resilience:**
    10. **Workflow Error Handling:**
        - âœ… **Try-Catch Blocks**: Wrap activity calls in proper error handling
        - âœ… **Retry Logic**: Implement workflow-level retry mechanisms
        - âœ… **Compensation**: Rollback completed steps on failures
        - âœ… **Error Propagation**: Return meaningful error information
        - âœ… **Logging**: Log errors with appropriate context and correlation IDs
    
    11. **Retry Strategies:**
        - âœ… **Exponential Backoff**: Use increasing delays between retries
        - âœ… **Jitter**: Add randomness to retry delays to prevent thundering herd
        - âœ… **Maximum Attempts**: Set reasonable limits on retry attempts
        - âœ… **Error Classification**: Different retry strategies for different error types
        - âœ… **Monitoring**: Track retry patterns and success rates
    
    
    
    **ğŸ“ˆ Observability & Monitoring:**
    12. **Metrics & Monitoring:**
        - âœ… **Workflow Metrics**: Track workflow execution times and success rates
        - âœ… **Activity Metrics**: Monitor activity performance and error rates
        - âœ… **Worker Metrics**: Track worker health and task processing rates
        - âœ… **Retry Metrics**: Monitor retry patterns and success rates
        - âœ… **Resource Usage**: Monitor memory, CPU, and connection usage
    
    13. **Logging & Tracing:**
        - âœ… **Structured Logging**: Use consistent log formats and field names
        - âœ… **Correlation IDs**: Include workflow and activity IDs in all logs
        - âœ… **Context Information**: Log relevant workflow state and parameters
        - âœ… **Error Details**: Include full error context and stack traces
        - âœ… **Performance Logging**: Log slow operations and bottlenecks
    
    **ğŸš¨ Common Anti-Patterns to Flag:**
    - âŒ Using system time or random numbers in workflows
    - âŒ Making direct I/O calls from workflows
    - âŒ Using global mutable state in workflows
    - âŒ Non-idempotent activities without idempotency keys
    - âŒ Missing timeout configurations for activities
    - âŒ No error handling or retry logic
    - âŒ Missing heartbeating for long-running activities
    - âŒ No monitoring or metrics implementation
    - âŒ Hardcoded retry policies or timeout values
    - âŒ Missing compensation logic for failed operations
    
    **ğŸ” Review Focus Areas:**
    - Verify workflow determinism and no side effects
    - Check activity idempotency and error handling
    - Ensure proper worker configuration and concurrency
    - Validate timeout and retry policy configurations
    - Review error handling and compensation logic
    - Check for monitoring and observability implementation
    - Identify opportunities for Prometheus metrics
    
    **ğŸ“Š Prometheus Metrics Opportunities:**
    - ğŸ” **Automatically suggest metrics when seeing:**
      - Workflow execution â†’ `temporal_workflows_total{workflow_type, status}`
      - Workflow duration â†’ `temporal_workflow_duration_seconds{workflow_type}`
      - Activity execution â†’ `temporal_activities_total{activity_type, status}`
      - Activity duration â†’ `temporal_activity_duration_seconds{activity_type}`
      - Worker metrics â†’ `temporal_worker_tasks_total{worker_id, status}`
      - Retry attempts â†’ `temporal_retries_total{operation_type, reason}`
      - Error handling â†’ `temporal_errors_total{type, operation}`
      - Timeout occurrences â†’ `temporal_timeouts_total{type, operation}`