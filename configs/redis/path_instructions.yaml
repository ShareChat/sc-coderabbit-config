# Redis & Caching Best Practices
- path: "**/{redis,df,dragonfly,cache,queue}*/**"
  instructions: |
    **Comprehensive Redis Code Review Checklist:**
    
    **ğŸ”‘ Key Management & Naming:**
    1. **Key Naming Conventions:**
       - âœ… Use clear, hierarchical key names (e.g., `user:123:profile`, `order:456:items`)
       - âœ… Keep keys concise to save memory space
       - âœ… Use consistent naming patterns across your application
       - âœ… Avoid excessively long key names (>100 characters)
       - âœ… Use colons (`:`) for hierarchical separation, not underscores or dashes
    
    2. **Key Expiration & TTL:**
       - âœ… Always set appropriate TTL for transient/cache data
       - âœ… Use `EXPIRE` or `PEXPIRE` for automatic cleanup
       - âš ï¸ Never set TTL to 0 (indefinite) for cache data
    
    **ğŸš€ Performance & Scalability:**
    3. **Avoiding Unbounded Operations:**
       - âœ… **Never use without limits**: `HGETALL`, `LRANGE`, `SMEMBERS`, `ZRANGE`
       - âœ… **Always check size first**: Use `HLEN`, `LLEN`, `SCARD`, `ZCARD`
       - âœ… **Use iterative commands**: `HSCAN`, `SSCAN`, `ZSCAN`, `LSCAN`
       - âœ… **Set reasonable limits**: `LRANGE key 0 99` instead of `LRANGE key 0 -1`
       - âœ… **Implement pagination**: Use `SCAN` with cursor-based iteration
    
    4. **Blocking Commands (Production Forbidden):**
       - âŒ **Never use in production**: `KEYS`, `FLUSHALL`, `FLUSHDB`
       - âœ… **Use alternatives**: `SCAN` for key discovery, selective deletion
       - âœ… **Implement safely**: Use `DEL` with specific keys, not pattern deletion
       - âœ… **Monitor usage**: Alert on any blocking command execution
    
    5. **Pipelining & Batching:**
       - âœ… Use pipelining for multiple related operations
       - âœ… Batch commands to reduce network round-trips
       - âœ… Use `MULTI`/`EXEC` for atomic operations when needed
    
    **ğŸ”Œ Connection & Resource Management:**
    6. **Connection Pooling:**
       - âœ… Configure appropriate pool size based on application load
       - âœ… Set `PoolSize`, `MinIdleConns`, `MaxIdleConns`
       - âœ… Configure `PoolTimeout` for connection acquisition
       - âœ… Monitor pool utilization and connection health
       - âœ… Implement connection health checks
    
    7. **Timeout Configuration:**
       - âœ… Set `ReadTimeout` for response reading operations
       - âœ… Set `WriteTimeout` for request writing operations
       - âœ… Set `DialTimeout` for connection establishment
       - âœ… Use reasonable timeout values (typically 1-30 seconds)
       - âš ï¸ Never use infinite timeouts
    
    8. **Resource Cleanup:**
        - âœ… Properly close Redis connections
        - âœ… Implement connection cleanup in application shutdown
        - âœ… Handle connection failures gracefully
        - âœ… Monitor for connection leaks
    
    **ğŸ“ˆ Error Handling & Resilience:**
    9. **Error Handling Strategies:**
        - âœ… Handle Redis connection failures gracefully
        - âœ… Implement retry logic with exponential backoff
        - âœ… Use circuit breaker patterns for Redis failures
        - âœ… Implement fallback strategies when Redis is unavailable
        - âœ… Log Redis errors with appropriate context
    
    10. **Fallback Mechanisms:**
        - âœ… Implement local caching when Redis is down
        - âœ… Use database as fallback for critical data
        - âœ… Graceful degradation of non-critical features
        - âœ… Monitor fallback usage and Redis health
    
    **ğŸ’¾ Data Management & Optimization:**
    11. **Compression & Serialization:**
        - âœ… Use compression for large values (gzip, zstd, lz4)
        - âœ… Choose appropriate serialization format (JSON, MessagePack, Protocol Buffers)
        - âœ… Monitor compression ratios and performance impact
        - âœ… Balance compression vs CPU overhead
    
    **ğŸ“Š Observability & Monitoring:**
    12. **Metrics & Monitoring:**
        - âœ… Track Redis operation latency and throughput
        - âœ… Monitor connection pool utilization
        - âœ… Track error rates and failure patterns
        - âœ… Monitor memory usage and key expiration
        - âœ… Implement health checks for Redis availability
    
    13. **Logging & Tracing:**
        - âœ… Log Redis operations with appropriate detail
        - âœ… Include correlation IDs for request tracing
        - âœ… Log slow queries and performance issues
        - âœ… Use structured logging with consistent field names
    
    
    **ğŸš¨ Common Anti-Patterns to Flag:**
    - âŒ Make sure that the redis client is not created for each request
    - âŒ Using `KEYS` command in production code
    - âŒ Unbounded `HGETALL`, `LRANGE`, `SMEMBERS` without size checks
    - âŒ Missing TTL for cache data
    - âŒ No connection pooling or timeout configuration
    - âŒ Hardcoded Redis credentials or connection strings
    - âŒ No error handling for Redis failures
    - âŒ Missing fallback mechanisms for Redis unavailability
    - âŒ No monitoring or health checks implemented
    - âŒ Using `FLUSHALL`/`FLUSHDB` in application code
    - âŒ No compression for large values
    
    **ğŸ” Review Focus Areas:**
    - Verify key naming conventions and TTL usage
    - Check for unbounded operations and blocking commands
    - Ensure proper connection pooling and timeout configuration
    - Validate security settings and authentication
    - Review error handling and fallback strategies
    - Check for monitoring and observability implementation
    - Identify opportunities for Prometheus metrics
    
    **ğŸ“Š Prometheus Metrics Opportunities:**
    - ğŸ” **Automatically suggest metrics when seeing:**
      - Redis operations â†’ `redis_operations_total{operation, status}`
      - Operation latency â†’ `redis_operation_duration_seconds{operation}`
      - Connection usage â†’ `redis_connections_active{state}`
      - Memory usage â†’ `redis_memory_bytes{type}`
      - Key operations â†’ `redis_keys_total{operation, data_type}`
      - Error handling â†’ `redis_errors_total{type, operation}`
      - Cache hits/misses â†’ `redis_cache_hits_total{key_pattern}`
