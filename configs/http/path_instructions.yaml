# HTTP Client Best Practices
- path: "**/{http,client,api,network}*/**"
  instructions: |
    **Comprehensive HTTP Client Code Review Checklist:**
    
    **ğŸ”§ Performance & Resource Management:**
    1. **Client Reuse & Connection Pooling:** 
       - âœ… Reuse HTTP client instances (don't create new clients per request)
       - âœ… Configure connection pool settings: `MaxIdleConns`, `MaxConnsPerHost`, `MaxIdleConnsPerHost`
       - âœ… Set appropriate `IdleConnTimeout` to prevent stale connections
       - âœ… Use `DisableKeepAlives: false` for better performance (unless specifically needed)
    
    2. **Timeouts (CRITICAL):**
       - âœ… Set `ConnectTimeout` for TCP connection establishment (e.g., 5-30s)
       - âœ… Set `RequestTimeout` for total request duration (e.g., 10-60s)
       - âœ… Set `ReadTimeout` for response body reading
       - âœ… Set `WriteTimeout` for request body writing
       - âš ï¸ Never use infinite timeouts - this can cause resource leaks
    
    3. **Resource Cleanup:**
       - âœ… Always close response body: `defer resp.Body.Close()` (Go) or equivalent
       - âœ… Handle response body even if you don't need it (read to EOF or close)
       - âœ… Use `io.Copy(io.Discard, resp.Body)` for discarding unwanted responses
    
    4. **Request Headers & Authentication:**
       - âœ… Set appropriate `User-Agent` header
       - âœ… Use secure authentication methods (Bearer tokens, API keys)
       - âœ… Don't log sensitive headers (Authorization, Cookie, etc.)
       - âœ… Set `Content-Type` and `Accept` headers appropriately
    
    **ğŸ“Š Error Handling & Resilience:**
    5. **Status Code Handling:**
       - âœ… Handle all status codes: 2xx (success), 4xx (client error), 5xx (server error)
       - âœ… Check `resp.StatusCode` before processing response body
       - âœ… Provide meaningful error messages for different status codes
       - âœ… Handle redirects appropriately (3xx status codes)
    
    6. **Retry Logic:**
       - âœ… Implement exponential backoff with jitter for transient errors
       - âœ… Only retry idempotent operations (GET, PUT, DELETE, not POST)
       - âœ… Set maximum retry attempts to prevent infinite loops
       - âœ… Use appropriate retry conditions (5xx errors, network timeouts)
    
    7. **Error Handling:**
       - âœ… Use language-appropriate error handling patterns
       - âœ… Wrap errors with context: `fmt.Errorf("failed to make request: %w", err)`
       - âœ… Handle network errors separately from HTTP errors
       - âœ… Provide actionable error messages for debugging
    
    **ğŸ“ˆ Observability & Monitoring:**
    8. **Logging & Tracing:**
       - âœ… Log request details (method, URL, headers) at DEBUG level
       - âœ… Log response status and timing at INFO level
       - âœ… Log errors with full context (request details, response status)
       - âœ… Use structured logging with consistent field names
       - âœ… Implement request/response correlation IDs for tracing
    
    9. **Metrics & Monitoring:**
      - âœ… Track request duration, status codes, and error rates
      - âœ… Monitor connection pool utilization
      - âœ… Alert on high error rates or timeout percentages
      - âœ… Use histetheus metrics for comprehensive monitoring
      
      **ğŸ“Š Prometheus Metrics Opportunities:**
      - ğŸ” **Automatically suggest metrics when seeing:**
        - HTTP requests â†’ `http_requests_total{method, endpoint, status_code}`
        - Response times â†’ `http_request_duration_seconds{method, endpoint}`
        - Error handling â†’ `http_errors_total{type, endpoint, status_code}`
        - Timeout handling â†’ `http_timeouts_total{type, endpoint}`
        - Connection pools â†’ `http_connection_pool_size{state}`
        - Retry logic â†’ `http_retries_total{endpoint, reason}`
        - Circuit breakers â†’ `http_circuit_breaker_state{endpoint}`
    
    **ğŸš¨ Common Anti-Patterns to Flag:**
    - âŒ Creating new HTTP client per request
    - âŒ Missing timeout configurations
    - âŒ Not closing response bodies
    - âŒ Ignoring HTTP status codes
    - âŒ Hardcoded URLs or credentials
    - âŒ No error handling for network failures
    - âŒ Infinite retry loops
    - âŒ Logging sensitive information
    
    **ğŸ” Review Focus Areas:**
    - Look for proper client configuration and reuse
    - Verify timeout settings are reasonable and not infinite
    - Check response body handling and cleanup
    - Ensure proper error handling and logging
    - Validate security practices (HTTPS, auth, headers)
    - Review retry logic for correctness and safety
    - Identify opportunities for Prometheus metrics
    - Suggest appropriate monitoring and alerting
    